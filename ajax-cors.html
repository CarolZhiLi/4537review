<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AJAX, API Calls & CORS</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .content-page {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .content-title {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-align: center;
            font-weight: 700;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: 700;
        }
        
        .subsection-title {
            color: #2c3e50;
            font-size: 1.4em;
            margin: 25px 0 15px 0;
            font-weight: 600;
        }
        
        .code-example {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            overflow-x: auto;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.5;
        }
        
        .question {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        
        .answer {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .info-box {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        
        .warning-box {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        
        .highlight {
            background: #f39c12;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            margin-bottom: 30px;
        }
        
        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .back-button::before {
            content: "‚Üê ";
            margin-right: 8px;
        }
        
        .step-list {
            counter-reset: step-counter;
        }
        
        .step-list li {
            counter-increment: step-counter;
            margin: 10px 0;
            padding-left: 30px;
            position: relative;
        }
        
        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: #667eea;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .content-page {
                padding: 20px;
            }
            
            .content-title {
                font-size: 2em;
            }
            
            .section {
                padding: 20px;
                margin-bottom: 30px;
            }
            
            .section-title {
                font-size: 1.5em;
            }
            
            .code-example {
                padding: 15px;
                font-size: 0.9em;
            }
        }
        
        @media (max-width: 480px) {
            .content-page {
                padding: 15px;
            }
            
            .content-title {
                font-size: 1.6em;
            }
            
            .section {
                padding: 15px;
            }
            
            .code-example {
                padding: 12px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">Back to Quiz Collection</a>
        
        <div class="content-page">
            <h1 class="content-title">üåê AJAX, API Calls & CORS</h1>
            
            <div class="section">
                <h2 class="section-title">Part 1: The Foundation - Asynchronous JavaScript and XML (AJAX)</h2>
                <p>AJAX allows a web page to communicate with a server in the background without reloading. This is achieved using the <code>XMLHttpRequest</code> (XHR) object.</p>
                
                <h3 class="subsection-title">1.1. The AJAX Lifecycle: <code>readyState</code> and <code>status</code></h3>
                <p>When you make a request, it goes through several stages. The <code>onreadystatechange</code> event fires at each stage.</p>
                
                <div class="info-box">
                    <strong>readyState Values:</strong>
                    <ul>
                        <li><strong>0 (UNSENT):</strong> The XHR object is created.</li>
                        <li><strong>1 (OPENED):</strong> <code>open()</code> has been called.</li>
                        <li><strong>2 (HEADERS_RECEIVED):</strong> <code>send()</code> was called, and response headers are received.</li>
                        <li><strong>3 (LOADING):</strong> The response body is being downloaded. Can fire multiple times.</li>
                        <li><strong>4 (DONE):</strong> The operation is complete.</li>
                    </ul>
                </div>
                
                <div class="info-box">
                    <strong>status Values:</strong>
                    <ul>
                        <li><strong>200 OK:</strong> The request was successful.</li>
                        <li><strong>404 Not Found:</strong> The server couldn't find the requested URL.</li>
                        <li><strong>500 Internal Server Error:</strong> The server had an unexpected error.</li>
                    </ul>
                </div>
                
                <h4>Code Example: Basic Structure</h4>
                <p>This code checks if the request is finished (<code>readyState == 4</code>) and was successful (<code>status == 200</code>) before using the response.</p>
                
                <div class="code-example">// This is the function that will handle the response
xhttp.onreadystatechange = function() {
  // Check if the request is complete AND successful
  if (this.readyState == 4 && this.status == 200) {
    // Access the server's response text and do something with it
    document.getElementById("demo").innerHTML = this.responseText;
  }
};</div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Part 2: Sending Data - GET vs. POST Requests</h2>
                
                <h3 class="subsection-title">2.1. GET Request: Retrieving Data</h3>
                <p><code>GET</code> requests are used to ask the server for data. All parameters are sent in the URL as a "query string".</p>
                
                <h4>Client-Side Code</h4>
                <div class="code-example">// Function to handle the GET request
function getAll() {
  const xhr = new XMLHttpRequest();
  const endPointRoot = "http://localhost:8888/API/v1/";
  const resource = "patients";
  // 1. Parameters are formatted as a query string starting with "?"
  let params = "?name=John&age=23";

  // 2. The final URL includes the endpoint, resource, and params
  const url = endPointRoot + resource + params;

  xhr.open("GET", url, true); // The full URL is used here

  xhr.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      document.getElementById("demo").innerHTML = this.responseText;
    }
  };
  
  // 3. send() is called with no arguments for a GET request.
  xhr.send();
}</div>
                
                <h4>Server-Side Code (Node.js)</h4>
                <p>The server extracts the parameters directly from the requested URL.</p>
                
                <div class="code-example">// In serverPostGet.js
const http = require('http');
const url = require('url');

http.createServer(function (req, res) {
  // Check if the request method is GET
  if (req.method === 'GET') {
    // 1. The 'url' module parses the request URL. 'true' creates a query object.
    const q = url.parse(req.url, true);

    // 2. Access the 'name' parameter from the parsed query object.
    const name = q.query['name']; // This will be "John"

    res.writeHead(200, { "Content-Type": "text/html" });
    res.end(`Hello ${name}, we received your GET request!`);
  }
}).listen(8888);</div>
                
                <h3 class="subsection-title">2.2. POST Request: Sending Data to Create/Update</h3>
                <p><code>POST</code> requests are used to send data to the server. The data is sent in the request body, not the URL.</p>
                
                <h4>Client-Side Code</h4>
                <div class="code-example">function sendRequest() {
  const name = document.getElementById("name").value;
  const xhr = new XMLHttpRequest();

  xhr.open("POST", "http://localhost:3000");

  // 1. CRITICAL: Set the Content-Type header. This tells the server how
  // to interpret the data in the body. 'x-www-form-urlencoded' means
  // the body is formatted like a query string (key=value&key2=value2).
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

  xhr.onload = function() {
    // 'onload' is a simpler way to handle a successful response (readyState 4, status 200-299)
    let response = xhr.responseText;
    document.getElementById("result").innerHTML = response;
  };

  // 2. The data is passed as an argument to send(). This puts it in the request body.
  xhr.send("name=" + name);
}</div>
                
                <h4>Server-Side Code (Node.js) - Handling Data in Chunks</h4>
                <p>The server must handle the request body as a <strong>stream</strong>, because it could be very large. It arrives in one or more "chunks".</p>
                
                <div class="code-example">// In POST server side
const http = require('http');
const { URLSearchParams } = require('url'); // Used to parse the body

const server = http.createServer(function(req, res) {
  if (req.method === "POST") {
    let body = "";

    // 1. Listen for the 'data' event. This fires for each chunk of data that arrives.
    req.on("data", function(chunk) {
      // Append the chunk to our body variable.
      body += chunk;
    });

    // 2. Listen for the 'end' event. This fires once ALL chunks have arrived.
    req.on("end", function() {
      // Now the 'body' variable contains the complete data (e.g., "name=John")
      
      // 3. Parse the url-encoded body string.
      const params = new URLSearchParams(body);
      const name = params.get("name");

      res.setHeader("Content-Type", "text/plain");
      res.setHeader("Access-Control-Allow-Origin", "*"); // For CORS
      res.write("Hello " + name);
      res.end();
    });
  }
});

server.listen(3000, function() {
  console.log("Server is running on port 3000");
});</div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Part 3: Security - Same-Origin Policy (SOP) & CORS</h2>
                
                <h3 class="subsection-title">3.1. The Problem: Same-Origin Policy (SOP)</h3>
                <p>A security feature in browsers that prevents a script on <code>http://my-site.com</code> from making an AJAX request to <code>http://api.com</code> because their <strong>origins</strong> (protocol, domain, port) do not match.</p>
                
                <h3 class="subsection-title">3.2. The Solution: Cross-Origin Resource Sharing (CORS)</h3>
                <p>CORS is the mechanism that allows a server to relax the SOP. It's <strong>configured on the server</strong> but <strong>enforced by the browser</strong>.</p>
                
                <h3 class="subsection-title">3.3. The Preflight Request (OPTIONS)</h3>
                <p>For "non-simple" requests (e.g., <code>DELETE</code>, <code>PUT</code>, or requests with custom headers like <code>Authorization</code> or <code>Content-Type: application/json</code>), the browser performs a safety check first.</p>
                
                <div class="step-list">
                    <ol>
                        <li><strong>Browser sends an OPTIONS request</strong> asking for permission.</li>
                        <li><strong>Server responds</strong> with headers indicating what methods and headers are allowed.</li>
                        <li><strong>If permitted, the browser sends the actual request</strong> (e.g., DELETE).</li>
                    </ol>
                </div>
                
                <h4>Server-Side Code (Node.js) - Handling a Preflight Request</h4>
                <p>This code specifically checks for the <code>OPTIONS</code> method (the preflight) and responds with the necessary permission headers without trying to process any data.</p>
                
                <div class="code-example">// From POST server side (simplified)
const server = http.createServer(function(req, res) {

  // --- PREFLIGHT REQUEST HANDLING ---
  // Check if the request is an OPTIONS preflight request.
  if (req.method === "OPTIONS") {
    // Respond with permission headers.
    res.setHeader("Access-Control-Allow-Origin", "*"); // Allow any origin
    res.setHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS"); // Allow these methods
    res.setHeader("Access-Control-Allow-Headers", "Content-Type"); // Allow this header
    res.writeHead(204); // 204 No Content is the standard for preflight responses
    res.end();
    return; // Stop processing further
  }

  // --- ACTUAL POST REQUEST HANDLING ---
  if (req.method === "POST") {
    // ... (code to handle chunks as shown in section 2.2) ...
    // IMPORTANT: The actual response ALSO needs the Allow-Origin header!
    res.setHeader("Access-Control-Allow-Origin", "*");
    // ... (rest of the POST handling) ...
  }
});</div>
            </div>
            
            <div class="section">
                <h2 class="section-title">Part 4: Common Questions & Summary</h2>
                
                <div class="question">
                    <strong>Why does Postman work when my browser fails?</strong>
                </div>
                <div class="answer">
                    Tools like Postman and <code>curl</code> are simple HTTP clients, not web browsers. They <strong>do not enforce the Same-Origin Policy</strong>. They will show you whatever response the server sends. A CORS error is a browser-specific security feature.
                </div>
                
                <div class="question">
                    <strong>Is CORS for "secure communication"?</strong>
                </div>
                <div class="answer">
                    No, this is misleading. <strong>HTTPS (SSL/TLS)</strong> provides secure, encrypted communication. <strong>CORS</strong> is an <strong>authorization policy</strong> that tells a browser which external websites are permitted to <em>read</em> a response.
                </div>
                
                <div class="info-box">
                    <h4>Key Takeaways:</h4>
                    <ul>
                        <li><strong>AJAX</strong> enables background communication between client and server</li>
                        <li><strong>GET</strong> requests send data in the URL, <strong>POST</strong> sends data in the request body</li>
                        <li><strong>Same-Origin Policy</strong> prevents cross-origin requests for security</li>
                        <li><strong>CORS</strong> allows servers to explicitly permit cross-origin requests</li>
                        <li><strong>Preflight requests</strong> (OPTIONS) are required for non-simple requests</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <script src="toggle-answers.js" defer></script>
</body>
</html>
